<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>無題ドキュメント</title>
<meta name="viewport" content="width=320, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
<link rel="stylesheet" href="./css/type.css">
<style>

</style>
</head>
<body>

<div id="typeApp">
  <div id="cardUI" ref="cardWrap">
    <!--template v-for="(d,i) in cardList" :key="d.id">
    <div class="card" :data-id="d.id" @touchstart.stop="onTouch">
      <div class="photo"><img :src="d.src" width="100%"></div>
      <div class="status">
        <dl>
          <dt>{{d.label}}-{{d.id}}</dt>
        </dl>
      </div>
    </div>
    </template-->
  </div>
  <div id="btnUI">
    <a href="#" class="btn skip" @click="onSkip"></a>
    <a href="#" class="btn type" @click="onType"></a>
  </div>
</div>

<script rel="preload" src="https://unpkg.com/vue/dist/vue.min.js" charset="utf-8" as="script"></script>
<script>
'use strict'
const returnApi = [
  {
    src: './img/type/mio_1.jpg',
    label: '今田美桜1 19歳 東京都'
  },
  {
    src: './img/type/mio_2.jpg',
    label: '今田美桜2 19歳 東京都'
  },
  {
    src: './img/type/mio_3.jpg',
    label: '今田美桜3 19歳 東京都'
  },
  {
    src: './img/type/mio_1.jpg',
    label: '今田美桜4 19歳 東京都'
  },
  {
    src: './img/type/mio_2.jpg',
    label: '今田美桜5 19歳 東京都'
  },
  {
    src: './img/type/mio_3.jpg',
    label: '今田美桜6 19歳 東京都'
  }
]
const returnApi2 = [
  {
    src: './img/type/mio_1.jpg',
    label: '今田美桜7 19歳 東京都'
  },
  {
    src: './img/type/mio_2.jpg',
    label: '今田美桜8 19歳 東京都'
  },
  {
    src: './img/type/mio_3.jpg',
    label: '今田美桜9 19歳 東京都'
  },
  {
    src: './img/type/mio_1.jpg',
    label: '今田美桜10 19歳 東京都'
  },
  {
    src: './img/type/mio_2.jpg',
    label: '今田美桜11 19歳 東京都'
  },
  {
    src: './img/type/mio_3.jpg',
    label: '今田美桜12 19歳 東京都'
  }
]
const CardStyle = class {
  constructor() {
    this.maxDeg = 15
    this.nextScale = 0.8
    this.reminingScale = 0.2
    this.preMaxScale = 0.95
    this.type = ''
    this.state = {}
    this.nextCard = ''
  }
  set setNextCard(el) {
    this.nextCard = el
  }
  set setType(c) {
    if (c === 1) {
      this.type = true
    } else if (c === -1) {
      this.type = false
    }
  }
  set setTouchState(obj) {
    const pageXOffset = window.pageXOffset
    const pageYOffset = window.pageYOffset
    const rect = obj.clientRect
    const relativePositionX = rect.left + pageXOffset
    const relativePositionY = rect.top + pageYOffset
    const halfWidth = Math.floor(rect.width / 2)
    this.assign({
      'relativePositionX': relativePositionX,
      'relativePositionY': relativePositionY,
      'halfWidth': halfWidth,
      'quarterWidth': halfWidth / 2,
      'relativeTouchstartX': obj.startX - relativePositionX,
      'relativeTouchstartY': obj.startY - relativePositionY
    })
  }
  set setRelativeMoveX(v) {
    const val = v - this.state.relativePositionX - this.state.relativeTouchstartX
    this.setType = Math.sign(val)
    this.assign({
      'relativeMoveX': val,
      'movingDistance': Math.abs(~~(val))
    })
  }
  set setRelativeMoveY(v) {
    const val = v - this.state.relativePositionY - this.state.relativeTouchstartY
    this.assign({
      'relativeMoveY': val
    })
  }
  swipeScale() {
    const state = this.state
    const calScale = this.nextScale + ( this.reminingScale * ( state.movingDistance / state.halfWidth ) )
    const setScale = calScale < this.preMaxScale ? calScale : this.preMaxScale
    this.scale(setScale)
  }
  assign(obj) {
    const assignArray = Object.assign(this.state,obj)
    this.state = assignArray
  }
  swipe(el) {
    const state = this.state
    const deg = this.maxDeg * (state.movingDistance / state.halfWidth)
    const setDeg = this.type ? -deg : deg
    const addClass = this.type ? 'type' : 'nottype'
    const rmClass = this.type ? 'nottype' : 'type'
    el.style.transform = `translate3d(${state.relativeMoveX}px, ${state.relativeMoveY}px, 0) rotate(${setDeg}deg)`
    el.classList.add(addClass)
    el.classList.remove(rmClass)
  }
  scale(scale) {
    const nextCard = this.nextCard
    nextCard.style.transform = `scale(${scale})`
  }
}

const CardItem = Vue.extend({
  template: `
    <div class="card" :class="setOrder" :data-id="generateObj.id" @touchstart.stop="onTouch" @touchmove.stop="onSwipe" @touchend.stop="onEnd">
      <div class="photo"><img :src="generateObj.src" width="100%"></div>
      <div class="status">
        <dl>
          <dt>{{generateObj.label}}-{{generateObj.id}}</dt>
        </dl>
      </div>
    </div>
  `,
  data() {
    return {
      generateObj: {
        id: Math.floor( Math.random() * 10000 ),
        src: '',
        label: '',
      },
      current: false,
      next: false,
      Card: new CardStyle()
    }
  },
  computed: {
    setOrder() {
      return {
        'current': this.current,
        'next': this.next
      }
    }
  },
  mounted() {
    const obj = {}
    obj[this.generateObj.id] = this
    this.$nextTick(function(){
      //typeApp.cardInstance.unshift(obj)
      Object.assign(typeApp.cardInstance,obj)
    })

    //const assignArray = Object.assign(this.state,obj)
  },
  methods: {
    onTouch(e) {
      const Card = this.Card
      const startX = e.changedTouches[0].pageX
      const startY = e.changedTouches[0].pageY
      console.log(startX)
    },
    onSwipe() {

    },
    onEnd() {
      this.onRelease()
    },
    onRelease() {
      vueBus.$emit('onRelease')
    }
  }
})

const vueBus = new Vue()
const typeApp = new Vue({
  el: '#typeApp',
  data: {
    loadedCardData: '',
    currentId: '',
    nextId: '',
    cardInstance: []
  },
  created() {
    this.loadedCardData = returnApi
    vueBus.$on('onRelease',this.onRelease)
  },
  computed: {
    cardList() {
      return this.loadedCardData
    },
    setOrderClass() {
      const length = this.cardList.length
      return function(i) {
        if((length - i ) === 1) {
          return 'current'
        } else if ((length - i ) === 2) {
          return 'next'
        }
      }
    },
    setScale() {
      const length = this.cardList.length
      return function(i) {
        const scale = 
        (length - i ) === 1
        ? 'scale(1)'
        : (length - i ) === 2
          ? 'scale(0.8)' 
          : 'scale(0.7)'
        return {
          transform: scale
        }
      }
    },
    cardWrap() {
      return this.$refs.cardWrap
    }
  },
  mounted(){
    this.setCardList(this.cardList,'mount')
    this.$nextTick(function(){
    })
  },
  directives: {
    card(el,binding) {
      const current = el.classList.contains('current')
      const onTouch = function(e) {
        e.stopPropagation()
        const startX = e.changedTouches[0].pageX
        const startY = e.changedTouches[0].pageY
        Card.setTouchState = {
          'clientRect': el.getBoundingClientRect(),
          'startX': startX,
          'startY': startY
        }
        el.style.transition = null
        Card.setNextCard = el.previousElementSibling
        Card.nextCard.style.transition = '.2s'
      }
      const onMove = function(e) {
        e.stopPropagation()

        const moveX = e.changedTouches[0].pageX
        const moveY = e.changedTouches[0].pageY
        Card.setRelativeMoveX = moveX
        Card.setRelativeMoveY = moveY
        Card.swipe(el)
        Card.swipeScale()
      }
      const onEnd = function(e) {
        e.stopPropagation()
        typeApp.updateCardData()
      }
      if(current) {
        var Card = new CardStyle()
        console.log('up')
        el.addEventListener('touchstart',onTouch)
        el.addEventListener('touchmove',onMove)
        el.addEventListener('touchend',onEnd)
      }
    }
  },
  methods: {
    setCardList(data,lifeCycle) {
      const vm = this
      const cardWrap = vm.cardWrap
      const isMount = (lifeCycle == 'mount')
      data.forEach(function(d,i){
        let cardItem = new CardItem()
        cardItem.generateObj.src = d.src
        cardItem.generateObj.label = d.label
        if (isMount) {
          if (i === 0) {
            cardItem.current = true
            vm.currentId = cardItem.generateObj.id
          } else if (i === 1) {
            cardItem.next = true
            vm.nextId = cardItem.generateObj.id
          }
        }
        cardItem.$mount()
        cardWrap.insertBefore(cardItem.$el,cardWrap.firstChild);
      })
    },
    onTouch(e) {
      const el = e.target
      console.log(el)
      console.log(el.previousElementSibling)
      //console.log(e.target.previousElementSibling)
      //this.updateCardData(e.target)
      el.parentNode.removeChild(el)
      const cardLength = this.cardWrap.querySelectorAll('.card').length
      if (cardLength < 4) {
        const addAPI = returnApi2
        this.setCardList(addAPI,'add')
      }
    },
    onRelease() {
      console.log('release')
    },
    async updateCardData(t){
      const vm = this
      const data = vm.loadedCardData
      function spliceList() {
        return new Promise(function(resolve){
          data.splice(data.length - 1,data.length)
          resolve()
        })
      }
      function addCard() {
        const remingList = vm.cardList.length
        if(remingList < 4) {
          const addAPI = returnApi2
          addAPI.forEach(function(item){
            data.splice(0,0,item)
          })
        }
      }
      await spliceList()
      await addCard()
      console.log(t)
    },
    onType() {
      const card = this.cardInstance[this.currentId]
    },
    onSkip() {

    }
  }
})
</script>
</body>
</html>
